# name: test/sql/local_oss_unity_catalog/secret_caching.test
# description: test secret caching for uc_catalog extension
# group: [local_oss_unity_catalog]

# Require statement will ensure this test is run with this extension loaded
require parquet

require uc_catalog

require delta

require httpfs

require-env UC_TEST_SERVER_RUNNING

statement ok
CREATE SECRET (
    TYPE UC,
    TOKEN 'not-used',
    ENDPOINT 'http://127.0.0.1:8080',
    AWS_REGION 'us-east-2'
);

# Catalog Secret
statement ok
ATTACH 'unity' AS my_catalog (TYPE UC_CATALOG);

# We can switch to a specific schema
statement ok
USE my_catalog.default;

# Test that we can query the table
query III
FROM marksheet LIMIT 5;
----
1	nWYHawtqUw	930
2	uvOzzthsLV	166
3	WIAehuXWkv	170
4	wYCSvnJKTo	709
5	VsslXsUIDZ	993

# Test secret caching - query the table again to ensure secrets are cached
query III
FROM marksheet LIMIT 3;
----
1	nWYHawtqUw	930
2	uvOzzthsLV	166
3	WIAehuXWkv	170

# Additional setup to test secret caching behavior
# This ensures secrets are properly cached between queries
statement ok
SELECT count(*) FROM marksheet;

# Verify that we can still query after the count
statement ok
SELECT * FROM marksheet LIMIT 1;

# Test filtering with the actual column name
# The original test used column0 < 3, but the table has a column called 'name'
# Since 'name' is a string column, we use a string comparison
# This tests that we can filter by the actual column name from Unity Catalog
# The key fix: using 'name' instead of the non-existent 'column0'
query III
FROM marksheet WHERE name < 'C';
----
7	BtDDvLeBpK	52
13	acpjQXpJCp	649
